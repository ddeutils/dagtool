name: sales_dag
type: dag
schedule: "@daily"
authors: ["de-team"]
tags:
  - sales
  - p1
tasks:
  - task: start
    op: empty

  - group: etl_sales_master
    upstream: start
    tasks:
      - task: extract
        op: python
        uses: libs.gcs.csv@1.1.0
        assets:
          - name: schema-mapping.json
            alias: schema
            convertor: basic
        params:
          path: gcs://{{ var("PROJECT_ID") }}/sales/master/date/{ exec_date:%y }

      - task: transform
        upstream: extract
        op: docker
        uses: docker.rgt.co.th/image.transform:0.0.1
        assets:
          - name: transform-query.sql
            alias: transform
        params:
          path: gcs://{{ var("PROJECT_ID") }}/landing/master/date/{ exec_date:%y }

      - group: sink
        upstream: transform
        tasks:
          - task: sleep
            op: python
            run: |
              import time
              time.sleep(5)

          - task: upload
            op: docker
            uses: docker.rgt.co.th/image.sink:0.0.1
            params:
              mode: overwrite
              path: gcs://{{ var("PROJECT_ID") }}/serving/master/data/{ exec_date:%y }

  - task: end
    upstream: etl_sales_master
    op: empty
