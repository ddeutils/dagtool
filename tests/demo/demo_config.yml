name: sales_dag
type: dag
schedule: "@daily"
authors: ["de-team"]
tasks:
  - name: start
    type: task
    op: empty

  - name: etl_sales_master
    upstream: start
    type: group
    tasks:
      - name: extract
        type: task
        op: python
        uses: libs.gcs.csv@1.1.0
        assets:
          - name: schema-mapping.json
            alias: schema
            convertor: basic
        params:
          path: gcs://{{ var("PROJECT_ID") }}/sales/master/date/{ exec_date:%y }

      - name: transform
        upstream: extract
        type: task
        op: docker
        uses: docker.rgt.co.th/image.transform:0.0.1
        assets:
          - name: transform-query.sql
            alias: transform
        params:
          path: gcs://{{ var("PROJECT_ID") }}/landing/master/date/{ exec_date:%y }

      - name: sink
        upstream: transform
        type: group
        tasks:
          - name: sleep
            type: task
            op: python
            run: |
              import time
              time.sleep(5)

          - name: upload
            type: task
            op: docker
            uses: docker.rgt.co.th/image.sink:0.0.1
            params:
              mode: overwrite
              path: gcs://{{ var("PROJECT_ID") }}/serving/master/data/{ exec_date:%y }

  - name: end
    upstream: etl_sales_master
    type: task
    op: empty
